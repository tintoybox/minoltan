<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cocolog投稿用テンプレート自動作成ツール</title>
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <style>
    body {font-family: 'Segoe UI', sans-serif;max-width: 800px;margin: 2rem auto;padding: 1rem;background: #f9f9fb;color: #333;}
    h1 { color: #2c3e50; text-align: center; }
    .upload-area {border: 3px dashed #3498db;border-radius: 12px;padding: 2rem;text-align: center;background: #ecf0f1;cursor: pointer;transition: 0.3s;}
    .upload-area:hover { background: #d6eaf8; }
    .upload-area.dragover { background: #a9dfbf; }
    #preview { margin: 1rem 0; text-align: center; }
    #preview img { max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    
    #output {
      background: #2c3e50;
      color: #f1c40f;
      padding: 1.5rem;
      border-radius: 12px;
      font-family: 'Courier New', monospace;
      position: relative;
      margin-top: 1.5rem;
      display: none;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    #output pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-all;
      font-size: 0.9rem;
      line-height: 1.4;
    }
    .copy-btn {
      position: sticky;
      top: 8px;
      float: right;
      z-index: 10;
      padding: 8px 16px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .copy-btn:hover { background: #c0392b; }
    
    .note {background: #fff3cd;border-left: 4px solid #ffc107;padding: 0.8rem;margin: 1rem 0;font-size: 0.9rem;color: #856404;}
    footer { text-align: center; margin-top: 3rem; color: #7f8c8d; font-size: 0.8rem; }
  </style>
</head>
<body>

  <h1>Cocolog投稿用テンプレート自動作成ツール</h1>

  <div class="upload-area" id="uploadArea">
    <p><strong>ここに写真をドラッグ＆ドロップ</strong><br>またはクリックして選択</p>
    <input type="file" id="photoInput" accept="image/jpeg,image/png" style="display:none;" />
  </div>

  <div id="preview"></div>

  <div id="output">
    <button class="copy-btn" id="copyBtn">コピー</button>
    <pre><code id="code"></code></pre>
  </div>

  <div class="note">
    <strong>使い方：</strong><br>
    1. 写真をアップロード<br>
    2. 生成されたコードを「コピー」<br>
    3. Cocologの投稿で「<strong>HTML編集</strong>」モードに切り替え<br>
    4. ペーストして保存 → 完了！
  </div>

  <footer>© 2025 Cocolog JSON-LD Template Generator</footer>

  <script>
    const uploadArea = document.getElementById('uploadArea');
    const photoInput = document.getElementById('photoInput');
    const preview = document.getElementById('preview');
    const output = document.getElementById('output');
    const code = document.getElementById('code');
    const copyBtn = document.getElementById('copyBtn');

    uploadArea.addEventListener('click', () => photoInput.click());
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, preventDefaults, false);
    });
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    ['dragenter', 'dragover'].forEach(eventName => {
      uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
    });
    uploadArea.addEventListener('drop', handleDrop, false);
    photoInput.addEventListener('change', e => handleFiles(e.target.files));

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      handleFiles(files);
    }

    function handleFiles(files) {
      if (!files.length) return;
      const file = files[0];
      if (!file.type.match('image.*')) {
        alert('画像ファイルを選択してください');
        return;
      }
      processImage(file);
    }

    function processImage(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          preview.innerHTML = `<img src="${e.target.result}" alt="プレビュー" />`;

          EXIF.getData(img, function() {
            const exif = {
              make: EXIF.getTag(this, "Make"),
              model: EXIF.getTag(this, "Model"),
              dateTime: EXIF.getTag(this, "DateTimeOriginal"),
              gpsLat: EXIF.getTag(this, "GPSLatitude"),
              gpsLatRef: EXIF.getTag(this, "GPSLatitudeRef"),
              gpsLng: EXIF.getTag(this, "GPSLongitude"),
              gpsLngRef: EXIF.getTag(this, "GPSLongitudeRef")
            };

            const lat = exif.gpsLat ? convertDMSToDD(exif.gpsLat, exif.gpsLatRef) : null;
            const lng = exif.gpsLng ? convertDMSToDD(exif.gpsLng, exif.gpsLngRef) : null;

            const jsonLd = {
              "@context": "https://schema.org",
              "@type": "ImageObject",
              "name": file.name,
              "contentUrl": e.target.result,
              "encodingFormat": file.type,
              "width": this.width,
              "height": this.height,
              "dateCreated": exif.dateTime ? exif.dateTime.replace(/:/g, '-', 0, 2) : null,
              "author": { "@type": "Person", "name": "あなたの名前" },
              "exifData": {
                "cameraMake": exif.make || null,
                "cameraModel": exif.model || null,
                "originalDateTime": exif.dateTime || null
              }
            };

            if (lat && lng) {
              jsonLd.contentLocation = {
                "@type": "Place",
                "geo": {
                  "@type": "GeoCoordinates",
                  "latitude": lat,
                  "longitude": lng
                }
              };
            }

            Object.keys(jsonLd).forEach(key => {
              if (jsonLd[key] === null) delete jsonLd[key];
              if (typeof jsonемонLd[key] === 'object') {
                Object.keys(jsonLd[key]).forEach(k => jsonLd[key][k] === null && delete jsonLd[key][k]);
              }
            });

            const htmlTemplate = `
<!-- 写真 -->
<p><img src="${e.target.result}" alt="${file.name}" style="max-width:100%; height:auto;" /></p>

<!-- 構造化データ（JSON-LD） -->
<script type="application/ld+json">
${JSON.stringify(jsonLd, null, 2)}
<\/script>

<!-- キャプション（任意） -->
<p>撮影日時: ${exif.dateTime || '不明'} | カメラ: ${exif.make || ''} ${exif.model || ''}</p>
`.trim();

            code.innerHTML = htmlTemplate
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;');
            output.style.display = 'block';
          });
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function convertDMSToDD(dms, ref) {
      if (!dms || dms.length < 3) return null;
      const [d, m, s] = dms.map(parseFloat);
      let dd = d + m/60 + s/3600;
      if (ref === 'S' || ref === 'W') dd = -dd;
      return parseFloat(dd.toFixed(6));
    }

    copyBtn.addEventListener('click', () => {
      const text = code.textContent || code.innerText;
      navigator.clipboard.writeText(text).then(() => {
        copyBtn.textContent = 'コピー完了！';
        setTimeout(() => copyBtn.textContent = 'コピー', 2000);
      });
    });
  </script>
</body>
</html>
