<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cocolog投稿用テンプレート自動作成ツール</title>
  <!-- exifr ライブラリ（CDN） -->
  <script src="https://cdn.jsdelivr.net/npm/exifr@7/dist/full.umd.min.js"></script>
  <style>
    body {font-family: 'Segoe UI', sans-serif;max-width: 800px;margin: 2rem auto;padding: 1rem;background: #f9f9fb;color: #333;}
    h1 { color: #2c3e50; text-align: center; }
    .upload-area {border: 3px dashed #3498db;border-radius: 12px;padding: 2rem;text-align: center;background: #ecf0f1;cursor: pointer;transition: 0.3s;}
    .upload-area:hover { background: #d6eaf8; }
    .upload-area.dragover { background: #a9dfbf; }
    #preview { margin: 1rem 0; text-align: center; }
    #preview img { max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    
    #output {
      background: #2c3e50;
      color: #f1c40f;
      padding: 1.5rem;
      border-radius: 12px;
      font-family: 'Courier New', monospace;
      position: relative;
      margin-top: 1.5rem;
      display: none;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    #output pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-all;
      font-size: 0.9rem;
      line-height: 1.4;
    }
    .copy-btn {
      position: sticky;
      top: 8px;
      float: right;
      z-index: 10;
      padding: 8px 16px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .copy-btn:hover { background: #c0392b; }
    
    .note {background: #fff3cd;border-left: 4px solid #ffc107;padding: 0.8rem;margin: 1rem 0;font-size: 0.9rem;color: #856404;}
    footer { text-align: center; margin-top: 3rem; color: #7f8c8d; font-size: 0.8rem; }
  </style>
</head>
<body>

  <h1>Cocolog投稿用テンプレート自動作成ツール</h1>

  <div class="upload-area" id="uploadArea">
    <p><strong>ここに写真をドラッグ＆ドロップ</strong><br>またはクリックして選択</p>
    <input type="file" id="photoInput" accept="image/jpeg,image/png" style="display:none;" />
  </div>

  <div id="preview"></div>

  <div id="output">
    <button class="copy-btn" id="copyBtn">コピー</button>
    <pre><code id="code"></code></pre>
  </div>

  <div class="note">
    <strong>使い方：</strong><br>
    1. 写真をアップロード<br>
    2. 生成されたコードを「コピー」<br>
    3. Cocologの投稿で「<strong>HTML編集</strong>」モードに切り替え<br>
    4. ペーストして保存 → 完了！
  </div>

  <footer>© 2025 Cocolog JSON-LD Template Generator</footer>

  <script>
    const uploadArea = document.getElementById('uploadArea');
    const photoInput = document.getElementById('photoInput');
    const preview = document.getElementById('preview');
    const output = document.getElementById('output');
    const code = document.getElementById('code');
    const copyBtn = document.getElementById('copyBtn');

    uploadArea.addEventListener('click', () => photoInput.click());
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, preventDefaults, false);
    });
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    ['dragenter', 'dragover'].forEach(eventName => {
      uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
    });
    uploadArea.addEventListener('drop', handleDrop, false);
    photoInput.addEventListener('change', e => handleFiles(e.target.files));

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      handleFiles(files);
    }

    function handleFiles(files) {
      if (!files.length) return;
      const file = files[0];
      if (!file.type.match('image.*')) {
        alert('画像ファイルを選択してください');
        return;
      }
      processImage(file);
    }

    async function processImage(file) {
      try {
        // 1. DataURL でプレビューとJSON-LD用
        const dataUrl = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(file);
        });

        // プレビュー表示
        preview.innerHTML = `<img src="${dataUrl}" alt="プレビュー" />`;

        // 2. ArrayBuffer でEXIF抽出（exifr使用）
        const arrayBuffer = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsArrayBuffer(file);
        });

        const exifObj = await exifr.parse(arrayBuffer, true);  // true: すべてのタグ取得

        // 画像サイズ取得（exifrから直接）
        const width = exifObj.PixelXDimension || 0;
        const height = exifObj.PixelYDimension || 0;

        // EXIFデータ抽出
        const make = exifObj.Make || null;
        const model = exifObj.Model || null;
        const dateTime = exifObj.DateTimeOriginal || null;

        // GPS抽出
        let lat = null, lng = null;
        if (exifObj.latitude !== undefined && exifObj.longitude !== undefined) {
          lat = exifObj.latitude;
          lng = exifObj.longitude;
        }

        // JSON-LD生成
        const jsonLd = {
          "@context": "https://schema.org",
          "@type": "ImageObject",
          "name": file.name,
          "contentUrl": dataUrl,
          "encodingFormat": file.type,
          "width": width,
          "height": height,
          "author": { "@type": "Person", "name": "あなたの名前" }
        };

        if (dateTime) {
          jsonLd.dateCreated = new Date(dateTime).toISOString().split('T')[0];
          jsonLd.exifData = {
            "cameraMake": make,
            "cameraModel": model,
            "originalDateTime": dateTime
          };
        }

        if (lat !== undefined && lng !== undefined) {
          jsonLd.contentLocation = {
            "@type": "Place",
            "geo": {
              "@type": "GeoCoordinates",
              "latitude": lat,
              "longitude": lng
            }
          };
        }

        // null削除
        Object.keys(jsonLd).forEach(key => {
          if (jsonLd[key] === null || (typeof jsonLd[key] === 'object' && Object.keys(jsonLd[key]).length === 0)) {
            delete jsonLd[key];
          } else if (typeof jsonLd[key] === 'object') {
            Object.keys(jsonLd[key]).forEach(k => jsonLd[key][k] === null && delete jsonLd[key][k]);
          }
        });

        const htmlTemplate = `
<!-- 写真 -->
<p><img src="${dataUrl}" alt="${file.name}" style="max-width:100%; height:auto;" /></p>

<!-- 構造化データ（JSON-LD） -->
<script type="application/ld+json">
${JSON.stringify(jsonLd, null, 2)}
<\/script>

<!-- キャプション（任意） -->
<p>撮影日時: ${dateTime || '不明'} | カメラ: ${make || ''} ${model || ''}</p>
`.trim();

        code.innerHTML = htmlTemplate
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
        output.style.display = 'block';
      } catch (err) {
        console.error("エラー:", err);
        alert("画像処理エラー: " + err.message);
      }
    }

    copyBtn.addEventListener('click', () => {
      const text = code.textContent || code.innerText;
      navigator.clipboard.writeText(text).then(() => {
        copyBtn.textContent = 'コピー完了！';
        setTimeout(() => copyBtn.textContent = 'コピー', 2000);
      });
    });
  </script>
</body>
</html>
