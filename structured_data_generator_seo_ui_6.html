<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>構造化データジェネレータ（完全安全版・スマホ固定＋夜間モード対応）</title>
<meta name="description" content="スマホ最適化・夜間モード対応・安全なscriptタグ付きJSON-LD出力。ImageObjectとBlogPostingの構造化データを生成。">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f8fafc;--text:#111;--card:#fff;--border:#e2e8f0;
  --accent:#2563eb;--danger:#dc2626;
  --code-bg:#1e293b;--code-text:#e2e8f0;
}
body.dark{
  --bg:#0f172a;--text:#e2e8f0;--card:#1e293b;--border:#334155;
  --accent:#3b82f6;--danger:#ef4444;--code-bg:#0f172a;--code-text:#e2e8f0;
}
body{
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
  background:var(--bg);color:var(--text);
  padding:16px;margin:0;max-width:1000px;
  transition:background 0.3s,color 0.3s;
}
h1{font-size:20px;margin-bottom:10px}
button,input,select,textarea{font-family:inherit}
button{
  background:var(--accent);color:#fff;border:none;
  padding:8px 12px;border-radius:6px;cursor:pointer;
}
button.ghost{background:var(--card);border:1px solid var(--accent);color:var(--accent)}
button.danger{background:var(--danger);color:#fff}
button.theme-toggle{margin-left:auto}
.card{
  background:var(--card);border:1px solid var(--border);
  border-radius:8px;padding:12px;margin-bottom:12px;
  box-shadow:0 1px 3px rgba(0,0,0,0.05);
}
.controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;align-items:center;}
@media(max-width:768px){
  .controls{
    position:fixed;top:0;left:0;right:0;z-index:1000;
    background:var(--card);border-bottom:1px solid var(--border);
    box-shadow:0 2px 4px rgba(0,0,0,0.1);padding:8px;overflow-x:auto;
  }
  body{padding-top:100px;}
}
pre{
  background:var(--code-bg);color:var(--code-text);
  padding:10px;border-radius:6px;overflow:auto;max-height:400px;font-size:13px;
}
label{display:block;font-size:14px;margin-top:6px}
input[type=text],input[type=date],textarea,select{
  width:100%;max-width:300px;
  padding:6px;border:1px solid var(--border);
  border-radius:6px;margin-top:3px;background:var(--card);color:var(--text);
}
textarea{resize:vertical;min-height:80px}
.photo-card{position:relative;width:100%;max-width:340px}
.remove-icon{position:absolute;top:6px;right:8px;background:transparent;color:var(--danger);border:none;font-size:18px;cursor:pointer}
.status{font-size:13px;padding:6px;border-radius:6px}
.status.ok{background:#dcfce7;color:#166534}
.status.warn{background:#fef9c3;color:#854d0e}
.small{font-size:13px;color:#64748b}
.grid{display:flex;flex-direction:column;gap:16px;}
@media(min-width:900px){.grid{flex-direction:row;align-items:flex-start;}aside{width:360px;}}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<h1>構造化データジェネレータ（完全安全版・スマホ固定＋夜間モード対応）</h1>

<div class="controls">
  <button id="addTop">＋ 写真フォーム追加</button>
  <button id="generateBtn">JSON-LD生成</button>
  <button id="copyBtn" class="ghost">JSONコピー</button>
  <button id="toggleFormat" class="ghost">📏 整形：ON</button>
  <button id="themeToggle" class="ghost theme-toggle">🌙 夜間モード</button>
  <label style="font-size:13px;">CSV読込<input id="csvInput" type="file" accept=".csv,text/csv" style="margin-top:4px;"></label>
</div>

<div class="grid">
  <main>
    <div id="photosContainer"></div>
    <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
      <button id="addBottom" class="ghost">＋ フォーム追加（下部）</button>
      <button id="clearAll" class="danger">すべて削除</button>
    </div>
  </main>

  <aside>
    <div class="card">
      <h2 style="font-size:16px;margin-bottom:6px;">BlogPosting（任意）</h2>
      <label>記事URL：<input type="text" id="bp_url" placeholder="https://example.com/blog/post"></label>
      <label>記事タイトル：<input type="text" id="bp_headline"></label>
      <label>代表画像URL：<input type="text" id="bp_image"></label>
      <label>著者名：<input type="text" id="bp_author" value="Tsuneaki Hiramatsu"></label>
      <label>投稿日：<input type="date" id="bp_date"></label>
      <label>本文：<textarea id="bp_body"></textarea></label>
    </div>

    <div class="card">
      <h3 style="font-size:15px;">出力プレビュー / ステータス</h3>
      <div id="status" class="status">未生成です。</div>
      <label style="margin-top:6px;">
        <input type="checkbox" id="includeScript"> &lt;script&gt;タグを付ける（安全エスケープ）
      </label>
      <details style="margin-top:6px;"><summary>生成結果を表示</summary><pre id="outputPre"></pre></details>
    </div>
  </aside>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  const photosContainer=document.getElementById('photosContainer');
  const csvInput=document.getElementById('csvInput');
  const statusEl=document.getElementById('status');
  const outputPre=document.getElementById('outputPre');
  const themeBtn=document.getElementById('themeToggle');
  const formatBtn=document.getElementById('toggleFormat');
  const includeScript=document.getElementById('includeScript');
  let lastGenerated=null,pretty=true;

  // 夜間モード
  const prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;
  if(prefersDark)document.body.classList.add('dark');
  themeBtn.onclick=()=>{document.body.classList.toggle('dark');
    themeBtn.textContent=document.body.classList.contains('dark')?'☀️ ライトモード':'🌙 夜間モード';};

  // JSON整形切替
  formatBtn.onclick=()=>{pretty=!pretty;
    formatBtn.textContent=pretty?"📏 整形：ON":"📏 整形：OFF";
    if(lastGenerated)renderOutput(lastGenerated);};

  const uid=()=>crypto.randomUUID();
  const updateStatus=(msg,ok=true)=>{statusEl.textContent=msg;statusEl.className="status "+(ok?"ok":"warn");};

  function createPhotoCard(prefill={}){
    const id=uid();
    const c=document.createElement('div');
    c.className='card photo-card';
    c.dataset.id=id;
    c.innerHTML=`
      <button class="remove-icon" title="削除">✕</button>
      <label>タイトル：<input type="text" id="imageTitle_${id}" value="${prefill.imageTitle||''}"></label>
      <label>説明文：<textarea id="caption_${id}">${prefill.caption||''}</textarea></label>
      <label>画像URL：<input type="text" id="contentUrl_${id}" value="${prefill.contentUrl||''}"></label>
      <label>撮影者名：<input type="text" id="creator_${id}" value="${prefill.creator||''}"></label>
      <label>撮影日：<input type="date" id="date_${id}" value="${prefill.datePublished||''}"></label>
      <label>撮影地名：<input type="text" id="locationName_${id}" value="${prefill.locationName||''}"></label>
      <label>緯度：<input type="text" id="latitude_${id}" value="${prefill.latitude||''}"></label>
      <label>経度：<input type="text" id="longitude_${id}" value="${prefill.longitude||''}"></label>
      <label>市区町村：<input type="text" id="locality_${id}" value="${prefill.locality||''}"></label>
      <label>都道府県：<input type="text" id="region_${id}" value="${prefill.region||''}"></label>`;
    c.querySelector('.remove-icon').onclick=()=>{c.remove();updateStatus("削除しました");};
    photosContainer.appendChild(c);
  }

  document.getElementById('addTop').onclick=()=>{createPhotoCard();updateStatus("フォーム追加");};
  document.getElementById('addBottom').onclick=()=>{createPhotoCard();updateStatus("フォーム追加（下）");};
  document.getElementById('clearAll').onclick=()=>{if(confirm("全削除しますか？")){photosContainer.innerHTML='';updateStatus("全削除しました");}};
  csvInput.addEventListener('change',e=>{
    const f=e.target.files[0];if(!f)return;
    Papa.parse(f,{header:true,complete:r=>{r.data.forEach(d=>createPhotoCard(d));updateStatus(r.data.length+"件読み込み");}});
  });

  function collectImages(){
    const imgs=[];
    photosContainer.querySelectorAll('.photo-card').forEach(card=>{
      const id=card.dataset.id;
      const g=k=>document.getElementById(k+'_'+id)?.value.trim();
      imgs.push({
        "@type":"ImageObject",
        name:g('imageTitle'),caption:g('caption'),
        contentUrl:g('contentUrl'),
        creator:g('creator')?{"@type":"Person","name":g('creator')}:undefined,
        datePublished:g('date'),
        locationCreated:{
          "@type":"Place",name:g('locationName'),
          geo:{"@type":"GeoCoordinates","latitude":g('latitude'),"longitude":g('longitude')},
          address:{"@type":"PostalAddress","addressLocality":g('locality'),"addressRegion":g('region'),"addressCountry":"JP"}
        }
      });
    });
    return imgs;
  }

  function renderOutput(data){
    let json=JSON.stringify(data,null,pretty?2:0);
    json=json.replace(/<\/script>/gi,"<\\/script>"); // ← 安全エスケープ
    outputPre.textContent=includeScript.checked?
`<script type="application/ld+json">
${json}
</script>`:json;
  }

  document.getElementById('generateBtn').onclick=()=>{
    const imgs=collectImages();
    const bp={
      "@type":"BlogPosting",
      headline:document.getElementById('bp_headline').value.trim(),
      image:imgs[0]?.contentUrl,
      author:{"@type":"Person","name":document.getElementById('bp_author').value.trim()},
      datePublished:document.getElementById('bp_date').value,
      articleBody:document.getElementById('bp_body').value.trim(),
      url:document.getElementById('bp_url').value.trim()
    };
    const out=[bp,...imgs]; out[0]["@context"]="https://schema.org";
    lastGenerated=out;
    renderOutput(out);
    updateStatus("JSON-LDを生成しました");
  };

  document.getElementById('copyBtn').onclick=async()=>{
    if(!lastGenerated)return alert("先に生成してください");
    let json=JSON.stringify(lastGenerated,null,pretty?2:0);
    json=json.replace(/<\/script>/gi,"<\\/script>");
    const text=includeScript.checked?`<script type="application/ld+json">\n${json}\n</script>`:json;
    await navigator.clipboard.writeText(text);
    updateStatus("クリップボードにコピーしました");
  };
});
</script>
</body>
</html>
